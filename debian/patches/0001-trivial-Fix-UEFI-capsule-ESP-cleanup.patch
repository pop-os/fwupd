From f1183aa84fd8730c26a6dca2c503510784c8262f Mon Sep 17 00:00:00 2001
From: Richard Hughes <richard@hughsie.com>
Date: Fri, 22 Mar 2024 12:33:53 +0000
Subject: [PATCH] trivial: Fix UEFI capsule ESP cleanup

See https://github.com/fwupd/fwupd/issues/6956

(cherry picked from commit 796b06b73847359567d7981f056a4dfa665ea760)
---
 plugins/uefi-capsule/fu-uefi-capsule-plugin.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/plugins/uefi-capsule/fu-uefi-capsule-plugin.c b/plugins/uefi-capsule/fu-uefi-capsule-plugin.c
index 81f762c1d..67e514955 100644
--- a/plugins/uefi-capsule/fu-uefi-capsule-plugin.c
+++ b/plugins/uefi-capsule/fu-uefi-capsule-plugin.c
@@ -1218,7 +1218,7 @@ static gboolean
 fu_uefi_capsule_plugin_cleanup_esp(FuUefiCapsulePlugin *self, GError **error)
 {
 	g_autofree gchar *esp_os_base = fu_uefi_get_esp_path_for_os();
-	g_autofree gchar *esp_path = fu_volume_get_mount_point(self->esp);
+	g_autofree gchar *esp_path = NULL;
 	g_autofree gchar *pattern = NULL;
 	g_autoptr(FuDeviceLocker) esp_locker = NULL;
 	g_autoptr(GPtrArray) files = NULL;
@@ -1227,6 +1227,7 @@ fu_uefi_capsule_plugin_cleanup_esp(FuUefiCapsulePlugin *self, GError **error)
 	esp_locker = fu_volume_locker(self->esp, error);
 	if (esp_locker == NULL)
 		return FALSE;
+	esp_path = fu_volume_get_mount_point(self->esp);
 	if (esp_path == NULL) {
 		g_set_error_literal(error,
 				    G_IO_ERROR,
-- 
2.34.1

