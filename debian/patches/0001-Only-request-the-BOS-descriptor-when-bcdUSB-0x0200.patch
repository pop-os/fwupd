From a54238d617659215d42c1d1f21c151cb95feb4fc Mon Sep 17 00:00:00 2001
From: Richard Hughes <richard@hughsie.com>
Date: Tue, 5 Mar 2024 17:11:16 +0000
Subject: [PATCH] Only request the BOS descriptor when bcdUSB > 0x0200

See https://techcommunity.microsoft.com/t5/microsoft-usb-blog/usb-2-1-2-0-1-1-device-enumeration-changes-in-windows-8/ba-p/270775

Fixes https://github.com/fwupd/fwupd/issues/6871
---
 libfwupdplugin/fu-usb-device.c     | 20 ++++++++++++++++++--
 src/tests/usb-devices-invalid.json |  2 +-
 src/tests/usb-devices.json         |  2 +-
 3 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/libfwupdplugin/fu-usb-device.c b/libfwupdplugin/fu-usb-device.c
index 8dfd6532b..11034a52f 100644
--- a/libfwupdplugin/fu-usb-device.c
+++ b/libfwupdplugin/fu-usb-device.c
@@ -672,6 +672,16 @@ fu_usb_device_probe_bos_descriptors(FuUsbDevice *self, GError **error)
 	g_autoptr(GError) error_local = NULL;
 	g_autoptr(GPtrArray) bos_descriptors = NULL;
 
+	/* not supported, so there is no point opening */
+	if (g_usb_device_get_spec(priv->usb_device) <= 0x0200) {
+		g_set_error(error,
+			    FWUPD_ERROR,
+			    FWUPD_ERROR_NOT_SUPPORTED,
+			    "not available as bcdUSB 0x%04x <= 0x0200",
+			    g_usb_device_get_spec(priv->usb_device));
+		return FALSE;
+	}
+
 	gusb_locker = fu_device_locker_new(priv->usb_device, error);
 	if (gusb_locker == NULL)
 		return FALSE;
@@ -809,8 +819,14 @@ fu_usb_device_probe(FuDevice *device, GError **error)
 
 #if G_USB_CHECK_VERSION(0, 4, 0)
 	/* parse the platform capability BOS descriptors for quirks */
-	if (!fu_usb_device_probe_bos_descriptors(self, &error_bos))
-		g_warning("failed to load BOS descriptor from USB device: %s", error_bos->message);
+	if (!fu_usb_device_probe_bos_descriptors(self, &error_bos)) {
+		if (g_error_matches(error_bos, FWUPD_ERROR, FWUPD_ERROR_NOT_SUPPORTED)) {
+			g_debug("ignoring: %s", error_bos->message);
+		} else {
+			g_warning("failed to load BOS descriptor from USB device: %s",
+				  error_bos->message);
+		}
+	}
 #endif
 #endif
 
diff --git a/src/tests/usb-devices-invalid.json b/src/tests/usb-devices-invalid.json
index 7a02c2ac1..65f0eb574 100644
--- a/src/tests/usb-devices-invalid.json
+++ b/src/tests/usb-devices-invalid.json
@@ -6,7 +6,7 @@
       "IdVendor": 10047,
       "IdProduct": 4100,
       "Device": 2,
-      "USB": 512,
+      "USB": 513,
       "Manufacturer": 1,
       "Product": 2,
       "UsbBosDescriptors": [
diff --git a/src/tests/usb-devices.json b/src/tests/usb-devices.json
index 584541138..18dbe3d3b 100644
--- a/src/tests/usb-devices.json
+++ b/src/tests/usb-devices.json
@@ -6,7 +6,7 @@
       "IdVendor": 10047,
       "IdProduct": 4100,
       "Device": 2,
-      "USB": 512,
+      "USB": 513,
       "Manufacturer": 1,
       "Product": 2,
       "UsbBosDescriptors": [
-- 
2.34.1

